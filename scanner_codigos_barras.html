<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Escáner de Códigos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial; padding: 16px; background: #f2f2f2; }
video { width: 100%; max-height: 300px; background: black; }
#result { margin-top: 16px; padding: 12px; background: white; font-size: 18px; }
</style>
</head>
<body>

<h2>Escáner de Códigos</h2>
<video id="video" autoplay playsinline></video>
<div id="result">Esperando código…</div>

<script>
if (!('BarcodeDetector' in window)) {
  document.getElementById('result').innerText =
    "Este navegador no soporta BarcodeDetector";
  throw new Error("BarcodeDetector no soportado");
}

const video = document.getElementById('video');
const resultDiv = document.getElementById('result');

let lastCode = null;
let lastTime = 0;

const detector = new BarcodeDetector({
  formats: ['ean_13', 'ean_8', 'upc_a', 'code_128']
});

navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
}).then(stream => {
  video.srcObject = stream;
  video.play();
  requestAnimationFrame(scan);
});

async function scan() {
  try {
    const barcodes = await detector.detect(video);
    if (barcodes.length > 0) {
      const code = barcodes[0].rawValue;
      const now = Date.now();

      if (code !== lastCode || now - lastTime > 2000) {
        lastCode = code;
        lastTime = now;

        let count = localStorage.getItem(code) || 0;
        count++;
        localStorage.setItem(code, count);

        resultDiv.innerText =
          `Código: ${code}\nEscaneado: ${count} veces`;
      }
    }
  } catch (e) {
    console.error(e);
  }
  requestAnimationFrame(scan);
}
</script>

</body>
</html>
