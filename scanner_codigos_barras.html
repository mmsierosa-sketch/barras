<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Contador de Códigos de Barras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial;
    margin: 0;
    padding: 16px;
    background: #f2f2f2;
}
h1 {
    text-align: center;
}
video {
    width: 100%;
    max-height: 300px;
    background: black;
    border-radius: 8px;
}
#result {
    margin-top: 16px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    font-size: 18px;
    text-align: center;
    white-space: pre-line;
}
#list {
    margin-top: 16px;
    padding: 12px;
    background: white;
    border-radius: 8px;
}
.code-row {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px solid #ddd;
}
button {
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
#exportBtn {
    background: #2e7d32;
    color: white;
}
#resetBtn {
    background: #d32f2f;
    color: white;
}
small { color: #555; }
</style>
</head>

<body>

<h1>Escáner de Códigos</h1>

<video id="video" autoplay playsinline></video>

<div id="result">Esperando código…</div>

<div id="list">
    <h3>Lista de productos</h3>
    <div id="codes"></div>
</div>

<button id="exportBtn" onclick="exportExcel()">Exportar a Excel</button>
<button id="resetBtn" onclick="resetAll()">Resetear lista</button>

<script>
/* ---------- PRODUCTOS ---------- */
const PRODUCTS = {
    "2400007217681": { name: "Protector", price: 19.99 },
    "2400007217735": { name: "Protector", price: 9.99 }
};

/* ---------- VARIABLES ---------- */
const video = document.getElementById('video');
const resultDiv = document.getElementById('result');
const codesDiv = document.getElementById('codes');

let currentVisibleCode = null;
let lastScanTime = 0;

/* ---------- SOPORTE ---------- */
if (!('BarcodeDetector' in window)) {
    alert("Este navegador no soporta BarcodeDetector");
    throw new Error("No soportado");
}

/* ---------- DETECTOR ---------- */
const detector = new BarcodeDetector({
    formats: ['ean_13', 'ean_8', 'upc_a', 'code_128']
});

/* ---------- CÁMARA ---------- */
navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
}).then(stream => {
    video.srcObject = stream;
    video.play();
    renderList();
    requestAnimationFrame(scan);
});

/* ---------- ESCANEO ---------- */
async function scan() {
    try {
        const barcodes = await detector.detect(video);

        if (barcodes.length === 0) {
            currentVisibleCode = null;
        } else {
            const code = barcodes[0].rawValue;
            const now = Date.now();

            if (code !== currentVisibleCode || now - lastScanTime > 1500) {
                currentVisibleCode = code;
                lastScanTime = now;

                let count = localStorage.getItem(code) || 0;
                count++;
                localStorage.setItem(code, count);

                const product = PRODUCTS[code];
                resultDiv.innerText = product
                    ? `Producto: ${product.name}\nPrecio: ${product.price.toFixed(2)} €\nCantidad: ${count}`
                    : `Código: ${code}\nCantidad: ${count}`;

                renderList();
            }
        }
    } catch {}
    requestAnimationFrame(scan);
}

/* ---------- LISTA ---------- */
function renderList() {
    codesDiv.innerHTML = "";

    if (!localStorage.length) {
        codesDiv.innerHTML = "<em>No hay productos escaneados</em>";
        return;
    }

    for (let i = 0; i < localStorage.length; i++) {
        const code = localStorage.key(i);
        const count = Number(localStorage.getItem(code));
        const product = PRODUCTS[code];

        const row = document.createElement("div");
        row.className = "code-row";

        row.innerHTML = product
            ? `<div><strong>${product.name}</strong><br><small>${code}</small></div>
               <div>${product.price.toFixed(2)} €</div>
               <strong>${count}</strong>`
            : `<div><strong>Desconocido</strong><br><small>${code}</small></div>
               <div>-</div>
               <strong>${count}</strong>`;

        codesDiv.appendChild(row);
    }
}

/* ---------- EXPORTAR EXCEL ---------- */
function exportExcel() {
    if (!localStorage.length) {
        alert("No hay datos para exportar");
        return;
    }

    let csv = "Código;Producto;Precio (€);Cantidad;Total (€)\n";

    for (let i = 0; i < localStorage.length; i++) {
        const code = localStorage.key(i);
        const qty = Number(localStorage.getItem(code));
        const product = PRODUCTS[code] || { name: "Desconocido", price: 0 };
        const total = (product.price * qty).toFixed(2);

        csv += `${code};${product.name};${product.price.toFixed(2)};${qty};${total}\n`;
    }

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "productos_escaneados.csv";
    a.click();

    URL.revokeObjectURL(url);
}

/* ---------- RESET ---------- */
function resetAll() {
    if (confirm("¿Borrar toda la lista?")) {
        localStorage.clear();
        currentVisibleCode = null;
        lastScanTime = 0;
        resultDiv.innerText = "Esperando código…";
        renderList();
    }
}
</script>

</body>
</html>
