<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Contador de Códigos de Barras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 16px;
    background: #f2f2f2;
}
h1 {
    text-align: center;
}
video {
    width: 100%;
    max-height: 300px;
    background: black;
    border-radius: 8px;
}
#result {
    margin-top: 16px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    font-size: 18px;
    text-align: center;
    white-space: pre-line;
}
</style>
</head>

<body>

<h1>Escáner de Códigos</h1>

<video id="video" autoplay playsinline></video>

<div id="result">Esperando código…</div>

<script>
/* ---------- CONFIGURACIÓN ---------- */
const video = document.getElementById('video');
const resultDiv = document.getElementById('result');

/* Código actualmente visible (para evitar duplicados) */
let currentVisibleCode = null;

/* Detector nativo del navegador (Chrome Android) */
if (!('BarcodeDetector' in window)) {
    resultDiv.innerText = "Este navegador no soporta BarcodeDetector";
    throw new Error("BarcodeDetector no soportado");
}

const detector = new BarcodeDetector({
    formats: ['ean_13', 'ean_8', 'upc_a', 'code_128']
});

/* ---------- CÁMARA ---------- */
navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
})
.then(stream => {
    video.srcObject = stream;
    video.play();
    requestAnimationFrame(scan);
})
.catch(err => {
    resultDiv.innerText = "Error al acceder a la cámara";
    console.error(err);
});

/* ---------- ESCANEO ---------- */
async function scan() {
    try {
        const barcodes = await detector.detect(video);

        if (barcodes.length === 0) {
            /* No hay código en pantalla → permitir nuevo escaneo */
            currentVisibleCode = null;
        } else {
            const code = barcodes[0].rawValue;

            /* Solo contar si es un código NUEVO en pantalla */
            if (code !== currentVisibleCode) {
                currentVisibleCode = code;

                let count = localStorage.getItem(code) || 0;
                count++;
                localStorage.setItem(code, count);

                resultDiv.innerText =
                    `Código: ${code}\nEscaneado: ${count} veces`;
            }
        }
    } catch (e) {
        console.error(e);
    }

    requestAnimationFrame(scan);
}
</script>

</body>
</html>
