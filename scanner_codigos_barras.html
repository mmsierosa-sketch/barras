<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>EscÃ¡ner Profesional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial;
    margin: 0;
    padding: 16px;
    background: #f2f2f2;
}
h1 { text-align: center; }
video {
    width: 100%;
    max-height: 300px;
    background: black;
    border-radius: 8px;
}
#result, #list {
    margin-top: 16px;
    padding: 12px;
    background: white;
    border-radius: 8px;
}
.code-row {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px solid #ddd;
}
button {
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
}
#exportBtn { background: #2e7d32; }
#resetBtn { background: #d32f2f; }
small { color: #555; }
</style>
</head>

<body>

<h1>EscÃ¡ner de CÃ³digos</h1>

<video id="video" autoplay playsinline></video>

<div id="result">Esperando cÃ³digoâ€¦</div>

<div id="list">
    <h3>Productos</h3>
    <div id="codes"></div>
</div>

<button id="exportBtn" onclick="exportExcel()">Exportar a Excel</button>
<button id="resetBtn" onclick="resetAll()">Resetear lista</button>

<script>
/* ---------- PRODUCTOS ---------- */
const PRODUCTS = {
    "2400007217681": { name: "Protector", price: 19.99 },
    "2400007217735": { name: "Protector", price: 9.99 }
};

/* ---------- VARIABLES ---------- */
const video = document.getElementById('video');
const resultDiv = document.getElementById('result');
const codesDiv = document.getElementById('codes');

let lastCode = null;
let lockedCode = null;
let emptyFrames = 0;
const EMPTY_FRAMES_REQUIRED = 15; // ðŸ‘ˆ CLAVE anti-duplicado

/* ---------- SONIDO ---------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep() {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "square";
    osc.frequency.value = 900;
    gain.gain.value = 0.1;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.12);
}

/* ---------- SOPORTE ---------- */
if (!('BarcodeDetector' in window)) {
    alert("BarcodeDetector no soportado");
    throw new Error("No soportado");
}

const detector = new BarcodeDetector({
    formats: ['ean_13', 'ean_8', 'upc_a', 'code_128']
});

/* ---------- CÃMARA ---------- */
navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
}).then(stream => {
    video.srcObject = stream;
    video.play();
    renderList();
    requestAnimationFrame(scan);
});

/* ---------- ESCANEO PROFESIONAL ---------- */
async function scan() {
    try {
        const barcodes = await detector.detect(video);

        if (barcodes.length === 0) {
            emptyFrames++;
            if (emptyFrames >= EMPTY_FRAMES_REQUIRED) {
                lockedCode = null; // ðŸ”“ desbloqueo REAL
            }
        } else {
            emptyFrames = 0;
            const code = barcodes[0].rawValue;

            // ðŸ”’ Si estÃ¡ bloqueado, ignorar
            if (lockedCode === code) {
                requestAnimationFrame(scan);
                return;
            }

            // âœ… Nuevo cÃ³digo vÃ¡lido
            lockedCode = code;
            lastCode = code;

            let count = Number(localStorage.getItem(code) || 0) + 1;
            localStorage.setItem(code, count);

            // ðŸ”Š feedback
            beep();
            if (navigator.vibrate) navigator.vibrate(100);

            const product = PRODUCTS[code];
            resultDiv.innerText = product
                ? `Producto: ${product.name}\nPrecio: ${product.price.toFixed(2)} â‚¬\nCantidad: ${count}`
                : `CÃ³digo: ${code}\nCantidad: ${count}`;

            renderList();
        }
    } catch (e) {
        console.error(e);
    }

    requestAnimationFrame(scan);
}

/* ---------- LISTA ---------- */
function renderList() {
    codesDiv.innerHTML = "";

    if (!localStorage.length) {
        codesDiv.innerHTML = "<em>No hay productos</em>";
        return;
    }

    for (let i = 0; i < localStorage.length; i++) {
        const code = localStorage.key(i);
        const qty = Number(localStorage.getItem(code));
        const product = PRODUCTS[code];

        const row = document.createElement("div");
        row.className = "code-row";
        row.innerHTML = product
            ? `<div><strong>${product.name}</strong><br><small>${code}</small></div>
               <div>${product.price.toFixed(2)} â‚¬</div>
               <strong>${qty}</strong>`
            : `<div><strong>Desconocido</strong><br><small>${code}</small></div>
               <div>-</div>
               <strong>${qty}</strong>`;
        codesDiv.appendChild(row);
    }
}

/* ---------- EXPORTAR ---------- */
function exportExcel() {
    let csv = "CÃ³digo;Producto;Precio;Cantidad;Total\n";
    for (let i = 0; i < localStorage.length; i++) {
        const code = localStorage.key(i);
        const qty = Number(localStorage.getItem(code));
        const p = PRODUCTS[code] || { name: "Desconocido", price: 0 };
        csv += `${code};${p.name};${p.price};${qty};${(p.price * qty).toFixed(2)}\n`;
    }

    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "productos.csv";
    a.click();
}

/* ---------- RESET ---------- */
function resetAll() {
    if (confirm("Â¿Borrar todo?")) {
        localStorage.clear();
        lockedCode = null;
        emptyFrames = 0;
        resultDiv.innerText = "Esperando cÃ³digoâ€¦";
        renderList();
    }
}
</script>

</body>
</html>
