<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Contador de Códigos de Barras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial;
    margin: 0;
    padding: 16px;
    background: #f2f2f2;
}
h1 {
    text-align: center;
}
video {
    width: 100%;
    max-height: 300px;
    background: black;
    border-radius: 8px;
}
#result {
    margin-top: 16px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    font-size: 18px;
    text-align: center;
    white-space: pre-line;
}
#list {
    margin-top: 16px;
    padding: 12px;
    background: white;
    border-radius: 8px;
}
#list h3 {
    margin-top: 0;
}
.code-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid #ddd;
}
.code-row:last-child {
    border-bottom: none;
}
button {
    width: 100%;
    margin-top: 12px;
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    background: #d32f2f;
    color: white;
    cursor: pointer;
}
button:hover {
    background: #b71c1c;
}
</style>
</head>

<body>

<h1>Escáner de Códigos</h1>

<video id="video" autoplay playsinline></video>

<div id="result">Esperando código…</div>

<div id="list">
    <h3>Lista de códigos</h3>
    <div id="codes"></div>
</div>

<button onclick="resetAll()">Resetear lista</button>

<script>
/* ---------- VARIABLES ---------- */
const video = document.getElementById('video');
const resultDiv = document.getElementById('result');
const codesDiv = document.getElementById('codes');

let currentVisibleCode = null;  // Código actualmente visible
let lastScanTime = 0;           // Última vez que se sumó

/* ---------- VERIFICAR SOPORTE ---------- */
if (!('BarcodeDetector' in window)) {
    resultDiv.innerText = "Este navegador no soporta BarcodeDetector";
    throw new Error("BarcodeDetector no soportado");
}

/* ---------- CONFIGURAR DETECTOR ---------- */
const detector = new BarcodeDetector({
    formats: ['ean_13', 'ean_8', 'upc_a', 'code_128']
});

/* ---------- CÁMARA ---------- */
navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
})
.then(stream => {
    video.srcObject = stream;
    video.play();
    renderList();
    requestAnimationFrame(scan);
})
.catch(err => {
    resultDiv.innerText = "Error al acceder a la cámara";
    console.error(err);
});

/* ---------- ESCANEO ---------- */
async function scan() {
    try {
        const barcodes = await detector.detect(video);

        if (barcodes.length === 0) {
            currentVisibleCode = null;  // Código desapareció → listo para nuevo
        } else {
            const code = barcodes[0].rawValue;
            const now = Date.now();

            // Evitar duplicados: solo contar si es un código nuevo
            // o si pasó más de 1.5 segundos desde el último escaneo
            if (code !== currentVisibleCode || (now - lastScanTime > 1500)) {
                currentVisibleCode = code;
                lastScanTime = now;

                let count = localStorage.getItem(code) || 0;
                count++;
                localStorage.setItem(code, count);

                resultDiv.innerText =
                    `Código: ${code}\nEscaneado: ${count} veces`;

                renderList();
            }
        }
    } catch (e) {
        console.error(e);
    }

    requestAnimationFrame(scan);
}

/* ---------- RENDER LISTA ---------- */
function renderList() {
    codesDiv.innerHTML = "";

    if (localStorage.length === 0) {
        codesDiv.innerHTML = "<em>No hay códigos escaneados</em>";
        return;
    }

    for (let i = 0; i < localStorage.length; i++) {
        const code = localStorage.key(i);
        const count = localStorage.getItem(code);

        const row = document.createElement("div");
        row.className = "code-row";
        row.innerHTML = `
            <span>${code}</span>
            <strong>${count}</strong>
        `;
        codesDiv.appendChild(row);
    }
}

/* ---------- RESET ---------- */
function resetAll() {
    if (confirm("¿Seguro que quieres borrar todos los códigos?")) {
        localStorage.clear();
        currentVisibleCode = null;
        lastScanTime = 0;
        resultDiv.innerText = "Esperando código…";
        renderList();
    }
}
</script>

</body>
</html>
