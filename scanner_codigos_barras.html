<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<title>Scanner Pro</title>

<style>
/* ---------- RESET ---------- */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: system-ui, Arial;
}

/* ---------- APP LAYOUT ---------- */
body {
  background: #111;
  overflow: hidden;
  color: white;
}

/* ---------- HEADER ---------- */
.header {
  height: 64px;
  background: #0f8a72;
  display: flex;
  justify-content: space-around;
  align-items: center;
  font-size: 14px;
}

.header div {
  text-align: center;
  opacity: .9;
}

/* ---------- VIDEO FULLSCREEN ---------- */
#video {
  position: absolute;
  top: 64px;
  left: 0;
  width: 100%;
  height: calc(100vh - 64px);
  object-fit: cover;
}

/* ---------- SCAN FRAME ---------- */
.scan-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 260px;
  height: 260px;
  transform: translate(-50%, -50%);
  border: 3px solid #ffb74d;
  border-radius: 12px;
  box-shadow: 0 0 0 9999px rgba(0,0,0,.55);
}

/* animaci√≥n l√≠nea */
.scan-line {
  position: absolute;
  width: 100%;
  height: 3px;
  background: #ffb74d;
  animation: scan 2s linear infinite;
}

@keyframes scan {
  from { top: 0; }
  to { top: 100%; }
}

/* ---------- BOTONES FLOTANTES ---------- */
.controls {
  position: absolute;
  top: 90px;
  width: 100%;
  display: flex;
  justify-content: space-around;
  font-size: 14px;
}

.controls button {
  background: rgba(0,0,0,.6);
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  color: white;
}

/* ---------- ZOOM ---------- */
.zoom {
  position: absolute;
  bottom: 25px;
  left: 50%;
  transform: translateX(-50%);
  width: 85%;
}

.zoom input {
  width: 100%;
}

/* ---------- RESULT BOX ---------- */
#result {
  position: absolute;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.7);
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 14px;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div>üì∑<br>Escanear</div>
  <div>‚úèÔ∏è<br>Crear</div>
  <div>üïò<br>Historial</div>
  <div>‚öôÔ∏è<br>Config</div>
</div>

<!-- VIDEO -->
<video id="video" autoplay playsinline></video>

<!-- MARCO -->
<div class="scan-frame">
  <div class="scan-line"></div>
</div>

<!-- BOTONES -->
<div class="controls">
  <button onclick="toggleFlash()">üî¶ Luz</button>
  <button onclick="exportExcel()">üì§ Exportar</button>
  <button onclick="resetAll()">üóë Reset</button>
</div>

<!-- RESULTADO -->
<div id="result">Esperando c√≥digo‚Ä¶</div>

<!-- ZOOM -->
<div class="zoom">
  <input type="range" min="1" max="3" step="0.1" value="1" id="zoomSlider">
</div>

<script>
/* ---------- PRODUCTOS ---------- */
const PRODUCTS = {
  "2400007217681": { name: "Protector", price: 19.99 },
  "2400007217735": { name: "Protector", price: 9.99 }
};

const video = document.getElementById("video");
const resultDiv = document.getElementById("result");
const zoomSlider = document.getElementById("zoomSlider");

let lockedCode = null;
let emptyFrames = 0;
const EMPTY_REQUIRED = 15;

/* ---------- BEEP ---------- */
const ctx = new (window.AudioContext || window.webkitAudioContext)();
function beep(){
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.connect(g); g.connect(ctx.destination);
  o.frequency.value=900;
  g.gain.value=.15;
  o.start(); o.stop(ctx.currentTime+.12);
}

/* ---------- C√ÅMARA ---------- */
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:"environment" }
}).then(stream=>{
  video.srcObject=stream;
  requestAnimationFrame(scan);
});

/* ---------- ZOOM ---------- */
zoomSlider.oninput = () => {
  video.style.transform = `scale(${zoomSlider.value})`;
};

/* ---------- DETECTOR ---------- */
const detector = new BarcodeDetector();

/* ---------- SCAN ---------- */
async function scan(){
  const codes = await detector.detect(video);

  if(!codes.length){
    emptyFrames++;
    if(emptyFrames>EMPTY_REQUIRED) lockedCode=null;
  } else {
    emptyFrames=0;
    const code=codes[0].rawValue;

    if(code!==lockedCode){
      lockedCode=code;

      let qty = Number(localStorage.getItem(code)||0)+1;
      localStorage.setItem(code,qty);

      beep();
      navigator.vibrate?.(80);

      const p=PRODUCTS[code];
      resultDiv.innerText=p
        ? `${p.name} | ${p.price}‚Ç¨ | x${qty}`
        : `${code} | x${qty}`;
    }
  }

  requestAnimationFrame(scan);
}

/* ---------- EXPORT ---------- */
function exportExcel(){
  let csv="Codigo;Producto;Precio;Cantidad\n";
  for(let i=0;i<localStorage.length;i++){
    const c=localStorage.key(i);
    const q=localStorage.getItem(c);
    const p=PRODUCTS[c]||{name:"Desconocido",price:0};
    csv+=`${c};${p.name};${p.price};${q}\n`;
  }
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="productos.csv";
  a.click();
}

/* ---------- RESET ---------- */
function resetAll(){
  if(confirm("Borrar todo?")){
    localStorage.clear();
    lockedCode=null;
    resultDiv.innerText="Esperando c√≥digo‚Ä¶";
  }
}

/* dummy flash */
function toggleFlash(){
  alert("El flash solo funciona en apps nativas, no web.");
}
</script>

</body>
</html>
